{
  "version": 3,
  "sources": ["../../src/lib/DeviceFactory.ts"],
  "sourcesContent": ["import type { Mydlink } from './mydlink';\nimport type { Device } from './Device';\nimport { processNetworkError, WrongMacError, WrongModelError } from './Device';\nimport type { TableDevice } from './TableDevice';\nimport { KnownDevices } from './KnownDevices';\nimport { WebSocketDevice } from './WebSocketDevice';\nimport { SoapDevice } from './soapDevice';\n\nfunction deviceObjetToTableDevice(configDevice: ioBroker.DeviceObject): TableDevice {\n    return {\n        name: configDevice.native.name,\n        mac: configDevice.native.mac,\n        ip: configDevice.native.ip,\n        pin: configDevice.native.pin,\n        pollInterval: configDevice.native.pollInterval,\n        enabled: configDevice.native.enabled,\n    };\n}\nfunction sendModelInfoToSentry(adapter: Mydlink, model: string, xml: Record<string, string>): void {\n    if (!KnownDevices[model]) {\n        //unknown device -> report to sentry.\n        adapter.log.info(\n            `Found new device, please report the following (full log from file, please) to developer: ${JSON.stringify(\n                xml,\n                null,\n                2,\n            )}`,\n        );\n        if (adapter.supportsFeature && adapter.supportsFeature('PLUGINS')) {\n            const sentryInstance = adapter.getPluginInstance('sentry');\n            if (sentryInstance) {\n                const Sentry = sentryInstance.getSentryObject();\n                if (Sentry) {\n                    Sentry.withScope((scope: any) => {\n                        scope.setLevel('info');\n                        for (const key of Object.keys(xml)) {\n                            scope.setExtra(key, xml[key]);\n                        }\n                        Sentry.captureMessage(`Unknown-Device ${model}`, 'info'); // Level 'info'\n                    });\n                }\n            }\n        }\n    }\n}\n\n/**\n * Create DeviceInfo from ioBroker object, old createDeviceFromConfig (model known)\n *\n * @param adapter ioBroker Adapter\n * @param configDevice ioBroker device object\n * @returns Promise<Device>\n */\nexport async function createFromObject(\n    adapter: Mydlink,\n    configDevice: ioBroker.DeviceObject,\n): Promise<Device | undefined> {\n    const native = configDevice.native;\n    const pinEncrypted = native.mac && !native.pinNotEncrypted;\n    if (native.model) {\n        return createDevice(adapter, {\n            ip: native.ip,\n            pin: native.pin,\n            pinEncrypted,\n            model: native.model,\n            pollInterval: Number(native.pollInterval),\n            mac: native.mac,\n            id: configDevice._id.split('.')[2],\n            name: native.name,\n            enabled: native.enabled,\n            isWebsocket: native.useWebsocket,\n        });\n    }\n    adapter.log.info(`Model still unknown for ${native.name}. Trying to identify.`);\n    return createFromTable(adapter, deviceObjetToTableDevice(configDevice), pinEncrypted, native.useWebsocket);\n}\n\n/**\n * Create a device with model known.\n *\n * @param adapter reference to the running adapter\n * @param params parameters for device creation\n * @param params.ip ip of device\n * @param params.pin pin of device\n * @param params.pinEncrypted is the supplied pin encrypted?\n * @param params.model model of device\n * @param params.pollInterval polling interval\n * @param params.mac mac address\n * @param params.id id of device\n * @param params.isWebsocket use websocket device?\n * @param params.name name of device\n * @param params.enabled is device enabled?\n */\nexport async function createDevice(\n    adapter: Mydlink,\n    params: {\n        ip: string;\n        pin: string;\n        pinEncrypted: boolean;\n        model: string;\n        pollInterval?: number;\n        mac?: string;\n        id?: string;\n        isWebsocket?: boolean;\n        name?: string;\n        enabled?: boolean;\n    },\n): Promise<Device | undefined> {\n    const deviceFlags = KnownDevices[params.model];\n    let device: SoapDevice | WebSocketDevice;\n    if (deviceFlags) {\n        device = new deviceFlags.DeviceType(adapter, params.ip, params.pin, params.pinEncrypted);\n        if (typeof deviceFlags.moreSetup === 'function') {\n            deviceFlags.moreSetup(device);\n        }\n    } else {\n        adapter.log.info(`Unknown device type ${params.model} for ${params.name}.`);\n        try {\n            let info: Record<string, string>;\n            if (params.isWebsocket) {\n                device = new WebSocketDevice(adapter, params.ip, params.pin, params.pinEncrypted);\n                const body = await device.getModelInfoForSentry();\n                info = { info: `UNKNOWN WEBSOCKET DEVICE: ${params.model}`, body };\n            } else {\n                device = new SoapDevice(adapter, params.ip, params.pin, params.pinEncrypted);\n                info = await device.client.getDeviceDescriptionXML();\n            }\n            sendModelInfoToSentry(adapter, params.model, info);\n        } catch (e: any) {\n            adapter.log.error(`Could not send device information to sentry. Please report. Error was: ${e.stack}`);\n            return undefined;\n        }\n    }\n\n    if (device !== undefined) {\n        device.pollInterval = Number(params.pollInterval || device.pollInterval);\n        device.mac = params.mac || device.mac;\n        device.id = params.id || device.id;\n        if (!device.id) {\n            device.idFromMac();\n        }\n        device.name = params.name || device.name;\n        device.model = params.model;\n        device.enabled = params.enabled !== undefined ? params.enabled : device.enabled;\n        device.isWebsocket = params.isWebsocket !== undefined ? params.isWebsocket : device.isWebsocket;\n    }\n    return device;\n}\n\n/**\n * Creates DeviceInfo from configuration-Table object (model unknown).\n *\n * @param adapter ioBroker Adapter\n * @param tableDevice device information from configuration table\n * @param [doDecrypt] do we need to decrypt the PIN?\n * @param [forceWebsocket] force usage of websocket device. Set to true, if soap already failed.\n * @returns @returns Promise<Device>\n */\nexport async function createFromTable(\n    adapter: Mydlink,\n    tableDevice: TableDevice,\n    doDecrypt = false,\n    forceWebsocket = false,\n): Promise<Device | undefined> {\n    const pinEncrypted = doDecrypt && Boolean(tableDevice.mac);\n    const mac = tableDevice.mac ? tableDevice.mac.toUpperCase() : '';\n\n    let device: SoapDevice | WebSocketDevice;\n    //first try soap:\n    if (!forceWebsocket) {\n        device = new SoapDevice(adapter, tableDevice.ip, tableDevice.pin, pinEncrypted);\n    } else {\n        device = new WebSocketDevice(adapter, tableDevice.ip, tableDevice.pin, pinEncrypted);\n    }\n\n    device.mac = mac;\n    device.pollInterval =\n        tableDevice.pollInterval !== undefined &&\n        isFinite(Number(tableDevice.pollInterval)) &&\n        tableDevice.pollInterval >= 0\n            ? Number(tableDevice.pollInterval)\n            : 30000;\n    if (device.mac) {\n        device.idFromMac();\n    }\n    device.name = tableDevice.name || device.name;\n    device.enabled = tableDevice.enabled !== undefined ? tableDevice.enabled : device.enabled;\n\n    try {\n        await device.login();\n        if (device.loggedIn) {\n            //ok, login worked. -> seems to be soap device, identify:\n            await device.identify();\n        } else {\n            if (!forceWebsocket) {\n                adapter.log.debug(`${device.name} could not login with SOAP, try websocket.`);\n                return createFromTable(adapter, tableDevice, doDecrypt, true);\n            }\n            throw new Error('Device not logged in... why?');\n        }\n    } catch (e: any) {\n        device.stop(); //stop old device in any case!\n        const code = processNetworkError(e);\n        if (!forceWebsocket && (code === 500 || code === 'ECONNREFUSED')) {\n            //try websocket.\n            return createFromTable(adapter, tableDevice, doDecrypt, true);\n        }\n\n        if (e.name === WrongModelError.errorName) {\n            //model was wrong -> recreate with new model information.\n            adapter.log.debug(`Found ${device.model} for ${device.name}. Create a fitting device.`);\n            return createDevice(adapter, {\n                model: device.model,\n                ip: device.ip,\n                pinEncrypted: false,\n                pin: device.pinDecrypted,\n                name: device.name,\n                mac: device.mac,\n                pollInterval: device.pollInterval,\n                id: device.id,\n                isWebsocket: device.isWebsocket,\n                enabled: device.enabled,\n            });\n        }\n\n        if (e.name === WrongMacError.errorName) {\n            adapter.log.info(\n                `Device with unexpected MAC ${device.mac} reacted on ${device.ip}. Trying to create new device object for it.`,\n            );\n            if (device.model) {\n                return createDevice(adapter, {\n                    model: device.model,\n                    ip: device.ip,\n                    pinEncrypted: false,\n                    pin: device.pinDecrypted,\n                    name: device.name,\n                    mac: device.mac,\n                    pollInterval: device.pollInterval,\n                    id: device.id,\n                    isWebsocket: device.isWebsocket,\n                    enabled: device.enabled,\n                });\n            }\n            return createFromTable(adapter, {\n                mac: device.mac,\n                ip: device.ip,\n                pin: device.pinDecrypted,\n                name: device.name,\n                pollInterval: device.pollInterval,\n                enabled: device.enabled,\n            });\n        }\n\n        adapter.log.debug(`Login error: ${e.stack}`);\n        if (\n            !device.loginErrorPrinted &&\n            e.code !== 'ETIMEDOUT' &&\n            e.code !== 'ECONNABORTED' &&\n            e.code !== 'ECONNRESET'\n        ) {\n            adapter.log.error(\n                `${\n                    tableDevice.name\n                } could not login. Please check credentials and if device is online/connected. Error: ${e.code} - ${\n                    e.stack\n                }`,\n            );\n            device.loginErrorPrinted = true;\n        }\n\n        device.loggedIn = false;\n    }\n\n    return device;\n}\n"],
  "mappings": "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",
  "names": []
}
