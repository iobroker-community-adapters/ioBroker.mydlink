{
  "version": 3,
  "sources": ["../../src/lib/Device.ts"],
  "sourcesContent": ["import type { Client } from './Clients';\nimport { DeviceInfo } from './DeviceInfo';\nimport { Suffixes } from './suffixes';\nimport type { Mydlink } from './mydlink';\n\n/**\n * Error indicating wrong MAC address.\n */\nexport class WrongMacError extends Error {\n    static errorName = 'WRONGMAC';\n    name = 'WRONGMAC';\n\n    /**\n     * Creates an instance of WrongMacError.\n     *\n     * @param message Error message\n     */\n    constructor(message: string) {\n        super(message);\n    }\n}\n\n/**\n * Error indicating wrong model.\n */\nexport class WrongModelError extends Error {\n    static errorName = 'WRONGMODEL';\n    name = 'WRONGMODEL';\n\n    /**\n     * Creates an instance of WrongModelError.\n     *\n     * @param message Error message\n     */\n    constructor(message: string) {\n        super(message);\n    }\n}\n\n/**\n * Get code from network error.\n *\n * @param e error object\n * @returns code as number or string\n */\nexport function processNetworkError(e: Record<string, any>): number | string {\n    if (e.response) {\n        // The request was made and the server responded with a status code\n        // that falls out of the range of 2xx\n        //See if we are logged out -> login again on next poll.\n        //otherwise ignore and try again later?\n        return e.response.status;\n    } else if (e.request) {\n        // The request was made but no response was received\n        // `error.request` is an instance of XMLHttpRequest in the browser and an instance of\n        // http.ClientRequest in node.js\n        //probably ECONNRESET or Timeout -> e.code should be set.\n        return e.code;\n    }\n    //something else...?\n    return e.code;\n}\n\n/**\n * Abstract device class. All devices inherit from this.\n */\nexport abstract class Device extends DeviceInfo {\n    readonly adapter: Mydlink;\n    abstract client: Client;\n    protected constructor(adapter: Mydlink, ip: string, pin: string, pinEncrypted: boolean) {\n        super(ip, pin, pinEncrypted);\n        this.adapter = adapter;\n    }\n\n    /**\n     * Stores device configuration as Device Object in ioBroker Database.\n     */\n    async createDeviceObject(): Promise<void> {\n        //do something here.\n        if (!this.id) {\n            if (!this.mac) {\n                this.adapter.log.warn(\n                    `Could not create device ${this.name} without MAC. Please check config or if device is online.`,\n                );\n                return;\n            }\n        }\n\n        //also set the native part of the device:\n        await this.adapter.extendObject(this.id, {\n            type: 'device',\n            common: {\n                name: this.name,\n                statusStates: {\n                    onlineId: `${this.adapter.namespace}.${this.id}${Suffixes.reachable}`,\n                },\n            } as Partial<ioBroker.DeviceCommon>,\n            native: {\n                ip: this.ip,\n                mac: this.mac,\n                pin: this.pinEncrypted,\n                pollInterval: Number(this.pollInterval),\n                enabled: this.enabled,\n                name: this.name,\n                model: this.model,\n                useWebSocket: this.isWebsocket,\n                pinNotEncrypted: false,\n            },\n        });\n    }\n\n    /**\n     * Creates state-objects for the device.\n     */\n    async createObjects(): Promise<void> {\n        //enabled indicator:\n        await this.adapter.setObjectNotExistsAsync(this.id + Suffixes.enabled, {\n            type: 'state',\n            common: {\n                name: 'enabled',\n                type: 'boolean',\n                role: 'indicator',\n                read: true,\n                write: false,\n            },\n            native: {},\n        });\n\n        //have ready indicator:\n        await this.adapter.setObjectNotExistsAsync(this.id + Suffixes.unreachable, {\n            type: 'state',\n            common: {\n                name: 'unreach',\n                type: 'boolean',\n                role: 'indicator.maintenance.unreach',\n                read: true,\n                write: false,\n            },\n            native: {},\n        });\n\n        //have ready indicator:\n        await this.adapter.setObjectNotExistsAsync(this.id + Suffixes.reachable, {\n            type: 'state',\n            common: {\n                name: 'device is reachable',\n                type: 'boolean',\n                role: 'indicator.reachable',\n                read: true,\n                write: false,\n            },\n            native: {},\n        });\n    }\n\n    /**\n     * Stops communication with device.\n     */\n    stop(): void {\n        if (this.intervalHandle) {\n            this.adapter.clearTimeout(this.intervalHandle);\n        }\n        if (this.client && typeof this.client.disconnect === 'function') {\n            this.client.disconnect();\n        }\n        this.ready = false;\n        this.loggedIn = false;\n    }\n\n    /**\n     * Starts log in for device. Needs to be done before additional commands can work.\n     */\n    async login(): Promise<boolean> {\n        try {\n            const loginResult = await this.client.login();\n            if (loginResult === true) {\n                this.adapter.log.debug(`${this.name} successfully logged in: ${loginResult}`);\n                this.loggedIn = true;\n                this.loginErrorPrinted = false;\n            } else {\n                if (!this.loginErrorPrinted) {\n                    this.loginErrorPrinted = true;\n                    this.loggedIn = false;\n                    this.adapter.log.debug(\n                        `Login error: device returned ${loginResult} - this should not really happen.`,\n                    );\n                    this.adapter.log.error(\n                        `${this.name} could not login. Please check credentials and if device is online/connected.`,\n                    );\n                }\n            }\n        } catch (e: any) {\n            this.adapter.log.debug(`Login error: ${e.stack}`);\n\n            if (\n                !this.loginErrorPrinted &&\n                e.code !== 'ETIMEDOUT' &&\n                e.code !== 'ECONNABORTED' &&\n                e.code !== 'ECONNRESET' &&\n                this.model\n            ) {\n                this.adapter.log.error(\n                    `${this.name} could not login. Please check credentials and if device is online/connected. Error: ${\n                        e.code\n                    } - ${e.stack}`,\n                );\n                this.loginErrorPrinted = true;\n            }\n\n            this.loggedIn = false;\n            if (!this.pollInterval && this.model) {\n                //if no polling takes place, need to retry login!\n                if (this.intervalHandle) {\n                    this.adapter.clearTimeout(this.intervalHandle);\n                }\n                this.intervalHandle = this.adapter.setTimeout(() => this.start(), 10000); //retry here if no polling.\n            }\n        }\n        return this.loggedIn;\n    }\n\n    /**\n     * Identification of device needs to happen after successful login.\n     * Problem: Maybe needs to create new object of new type. Hm...\n     */\n    async identify(): Promise<boolean> {\n        //for device identification by IP set name to model here:\n        if (!this.name) {\n            this.name = this.model;\n        }\n\n        await this.createObjects();\n        this.identified = true;\n        return this.identified;\n    }\n\n    /**\n     * Handle network error during communication.\n     *\n     * @param e error object\n     * @returns code as number or string\n     */\n    async handleNetworkError(e: any): Promise<number | string> {\n        const code = processNetworkError(e);\n        if ([403, 424].includes(code as number) || this.ready) {\n            this.loggedIn = false; //login next polling.\n        }\n        this.adapter.log.debug(`Error during communication ${this.name}: ${code} - ${e.stack} - ${e.body}`);\n        this.ready = false;\n        if (this.id) {\n            await this.adapter.setStateChangedAsync(this.id + Suffixes.unreachable, true, true);\n            await this.adapter.setStateChangedAsync(this.id + Suffixes.reachable, false, true);\n        }\n        return code;\n    }\n\n    /**\n     * Do polling here.\n     *\n     * @returns void\n     */\n    async onInterval(): Promise<void> {\n        //this.log.debug('Polling ' + this.name);\n        try {\n            if (!this.loggedIn) {\n                await this.login();\n            }\n            if (this.loggedIn && !this.identified) {\n                await this.identify();\n            }\n            if (this.loggedIn && this.identified) {\n                this.ready = await this.client.isDeviceReady();\n                await this.adapter.setStateChangedAsync(this.id + Suffixes.unreachable, !this.ready, true);\n                await this.adapter.setState(this.id + Suffixes.reachable, this.ready, true);\n            }\n        } catch (e: any) {\n            await this.handleNetworkError(e);\n        }\n\n        if (this.pollInterval > 0) {\n            //only start timeout again, if set in settings.\n            this.intervalHandle = this.adapter.setTimeout(() => this.onInterval(), this.pollInterval);\n        }\n    }\n\n    /**\n     * starting communication with device from config.\n     *\n     * @returns void\n     */\n    async start(): Promise<void> {\n        //if device was already started -> stop it.\n        //(use case: ip did change or settings did change)\n        if (this.ready) {\n            this.stop();\n        }\n\n        //interrogate enabled devices\n        //this will get MAC for manually configured devices.\n        if (this.enabled) {\n            //login:\n            await this.login();\n            if (this.loggedIn) {\n                try {\n                    await this.identify();\n                    this.ready = await this.client.isDeviceReady();\n                    await this.adapter.setState(this.id + Suffixes.reachable, this.ready, true);\n                    await this.adapter.setState(this.id + Suffixes.unreachable, !this.ready, true);\n                } catch (e: any) {\n                    this.adapter.log.error(`${this.name} could not identify device: ${e.stack}`);\n                }\n            }\n        }\n\n        //transfer enabled flag to object:\n        await this.adapter.setState(this.id + Suffixes.enabled, { val: this.enabled, ack: true });\n\n        //start polling if device is enabled (do this after all is set up).\n        if (this.enabled) {\n            //some devices, for example W245, don't push. So poll websocket also.\n            let interval = this.pollInterval;\n            if (interval !== undefined && !Number.isNaN(interval) && interval > 0) {\n                if (interval < 500) {\n                    this.adapter.log.warn('Increasing poll rate to twice per second. Please check device config.');\n                    interval = 500; //polling twice every second should be enough, right?\n                }\n                if (interval >= 2147483647) {\n                    interval = 2147483646;\n                    this.adapter.log.warn('Poll rate was too high, reduced to prevent issues.');\n                }\n                this.adapter.log.debug(`Start polling for ${this.name} with interval ${interval}`);\n                this.pollInterval = interval;\n                this.intervalHandle = this.adapter.setTimeout(() => this.onInterval(), this.pollInterval);\n            } else {\n                this.pollInterval = 0;\n                this.adapter.log.debug(`Polling of ${this.name} disabled, interval was ${interval} (0 means disabled)`);\n            }\n        }\n    }\n\n    /**\n     * process a state change.\n     *\n     * @param _id of state\n     * @param _state new state\n     */\n    async handleStateChange(_id: string, _state: ioBroker.State): Promise<void> {\n        if (this.loggedIn) {\n            await this.login();\n        }\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
